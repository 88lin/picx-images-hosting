(function(window) {
    'use strict';

    const ACTIVATION_CONFIG = {
        validCodes: [
            { hash: "5f85190c4f166864b399e739854c7f1822035b945f689c687749c0ac519ca944", maxUses: 10, validDays: 365 },
            { hash: "78db704c0f4cffcb6b9657c8a57024b35c6c297a8900101e3a38b9c4c0621931", maxUses: 10, validDays: 365 },
        ],
        storagePrefix: '_ayp_sys_',
        deviceKey: '_ayp_device_fp_'
    };

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    function generateDeviceFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('AYP Device Fingerprint', 2, 2);
        const canvasData = canvas.toDataURL();

        const screenData = `${screen.width}x${screen.height}x${screen.colorDepth}`;
        const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const language = navigator.language;
        const platform = navigator.platform;
        const userAgent = navigator.userAgent;

        const fingerprint = `${canvasData}|${screenData}|${timeZone}|${language}|${platform}|${userAgent}`;
        return fingerprint;
    }

    async function getDeviceId() {
        let deviceId = localStorage.getItem(ACTIVATION_CONFIG.deviceKey);
        if (!deviceId) {
            const fingerprint = generateDeviceFingerprint();
            deviceId = await sha256(fingerprint + Date.now() + Math.random());
            localStorage.setItem(ACTIVATION_CONFIG.deviceKey, deviceId);
        }
        return deviceId;
    }

    async function checkActivationStatus() {
        const deviceId = await getDeviceId();
        const activationData = localStorage.getItem(ACTIVATION_CONFIG.storagePrefix + 'activation');

        if (!activationData) {
            return { activated: false };
        }

        try {
            const data = JSON.parse(atob(activationData));

            if (data.deviceId !== deviceId) {
                return { activated: false, reason: 'device_mismatch' };
            }

            if (data.expireTime && Date.now() > data.expireTime) {
                localStorage.removeItem(ACTIVATION_CONFIG.storagePrefix + 'activation');
                return { activated: false, reason: 'expired' };
            }

            const expectedSignature = await sha256(data.codeHash + data.deviceId + data.activateTime);
            if (data.signature !== expectedSignature) {
                return { activated: false, reason: 'invalid_signature' };
            }

            return {
                activated: true,
                expireTime: data.expireTime,
                activateTime: data.activateTime
            };
        } catch (e) {
            return { activated: false, reason: 'corrupted_data' };
        }
    }

    async function activateCode(code) {
        const statusEl = document.getElementById('activation-status');
        const codeInput = document.getElementById('activation-code');
        const codeText = (code || codeInput.value).trim().toUpperCase();

        if (!codeText) {
            if (statusEl) {
                statusEl.textContent = 'âŒ è¯·è¾“å…¥æ¿€æ´»ç ';
                statusEl.className = 'activation-status error';
            }
            return false;
        }

        if (statusEl) {
            statusEl.textContent = 'â³ éªŒè¯ä¸­...';
            statusEl.className = 'activation-status warning';
        }

        try {
            const codeHash = await sha256(codeText);
            const deviceId = await getDeviceId();

            const matchedCode = ACTIVATION_CONFIG.validCodes.find(c => c.hash === codeHash);

            if (!matchedCode) {
                if (statusEl) {
                    statusEl.textContent = 'âŒ æ— æ•ˆçš„æ¿€æ´»ç ï¼Œè¯·æ£€æŸ¥åé‡è¯•';
                    statusEl.className = 'activation-status error';
                }
                return false;
            }

            const usageKey = ACTIVATION_CONFIG.storagePrefix + 'usage_' + codeHash;
            const usageData = localStorage.getItem(usageKey);
            let currentUses = 0;
            let usedDevices = [];

            if (usageData) {
                try {
                    const parsed = JSON.parse(atob(usageData));
                    currentUses = parsed.count || 0;
                    usedDevices = parsed.devices || [];
                } catch (e) {}
            }

            if (usedDevices.includes(deviceId)) {
                if (statusEl) {
                    statusEl.textContent = 'âš ï¸ æ­¤æ¿€æ´»ç å·²åœ¨å½“å‰è®¾å¤‡ä½¿ç”¨è¿‡';
                    statusEl.className = 'activation-status warning';
                }

                const status = await checkActivationStatus();
                if (status.activated) {
                    if (statusEl) {
                        statusEl.textContent = 'âœ… å½“å‰è®¾å¤‡å·²æ¿€æ´»ï¼Œæ— éœ€é‡å¤æ¿€æ´»';
                        statusEl.className = 'activation-status success';
                    }
                    if (window.updateActivationUI) window.updateActivationUI(status);
                }
                return status.activated;
            }

            if (currentUses >= matchedCode.maxUses) {
                if (statusEl) {
                    statusEl.textContent = 'âŒ æ­¤æ¿€æ´»ç å·²è¾¾åˆ°æœ€å¤§ä½¿ç”¨æ¬¡æ•°';
                    statusEl.className = 'activation-status error';
                }
                return false;
            }

            const activateTime = Date.now();
            const expireTime = activateTime + (matchedCode.validDays * 24 * 60 * 60 * 1000);
            const signature = await sha256(codeHash + deviceId + activateTime);

            const activationData = {
                codeHash: codeHash,
                deviceId: deviceId,
                activateTime: activateTime,
                expireTime: expireTime,
                signature: signature
            };

            localStorage.setItem(
                ACTIVATION_CONFIG.storagePrefix + 'activation',
                btoa(JSON.stringify(activationData))
            );

            usedDevices.push(deviceId);
            const newUsageData = {
                count: currentUses + 1,
                devices: usedDevices
            };
            localStorage.setItem(usageKey, btoa(JSON.stringify(newUsageData)));

            if (statusEl) {
                statusEl.textContent = `âœ… æ¿€æ´»æˆåŠŸï¼æœ‰æ•ˆæœŸè‡³ ${new Date(expireTime).toLocaleDateString()}`;
                statusEl.className = 'activation-status success';
            }

            if (window.updateActivationUI) {
                window.updateActivationUI({ activated: true, expireTime, activateTime });
            }

            if (window.showNotification) {
                window.showNotification('ğŸ‰ æ¿€æ´»æˆåŠŸï¼å®Œæ•´åŠŸèƒ½å·²è§£é”');
                setTimeout(() => location.reload(), 600);
            }

            return true;
        } catch (error) {
            console.error('Activation error:', error);
            if (statusEl) {
                statusEl.textContent = 'âŒ æ¿€æ´»è¿‡ç¨‹å‡ºé”™ï¼Œè¯·é‡è¯•';
                statusEl.className = 'activation-status error';
            }
            return false;
        }
    }

    async function initializeActivation() {
        const deviceId = await getDeviceId();
        const deviceIdDisplay = document.getElementById('device-id-display');
        if (deviceIdDisplay) {
            deviceIdDisplay.textContent =
                `è®¾å¤‡ID: ${deviceId.substring(0, 8)}...${deviceId.substring(deviceId.length - 8)}`;
        }

        const status = await checkActivationStatus();
        window.isActivated = status.activated;

        if (window.updateActivationUI) {
            window.updateActivationUI(status);
        }

        if (!status.activated && status.reason) {
            const statusEl = document.getElementById('activation-status');
            if (statusEl) {
                switch (status.reason) {
                    case 'expired':
                        statusEl.textContent = 'âš ï¸ æ‚¨çš„æ¿€æ´»å·²è¿‡æœŸï¼Œè¯·é‡æ–°æ¿€æ´»';
                        statusEl.className = 'activation-status warning';
                        break;
                    case 'device_mismatch':
                        statusEl.textContent = 'âš ï¸ è®¾å¤‡ä¸åŒ¹é…ï¼Œè¯·åœ¨å½“å‰è®¾å¤‡é‡æ–°æ¿€æ´»';
                        statusEl.className = 'activation-status warning';
                        break;
                }
            }
        }

        return status;
    }

    // ä»£ç ä¿æŠ¤
    function initProtection() {
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            if (window.showNotification) {
                window.showNotification('âš ï¸ å³é”®èœå•å·²ç¦ç”¨');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.keyCode === 123 || // F12
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
                (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
                (e.ctrlKey && e.keyCode === 83)) { // Ctrl+S
                e.preventDefault();
                if (window.showNotification) {
                    window.showNotification('âš ï¸ æ­¤åŠŸèƒ½å·²ç¦ç”¨');
                }
            }
        });

        let devtools = { open: false };
        const threshold = 160;

        setInterval(function() {
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;

            if (widthThreshold || heightThreshold) {
                if (!devtools.open) {
                    devtools.open = true;
                    console.clear();
                    console.log('%câš ï¸ è­¦å‘Š', 'color: red; font-size: 50px; font-weight: bold;');
                    console.log('%cæ­¤æµè§ˆå™¨åŠŸèƒ½ä»…ä¾›æˆæƒå¼€å‘äººå‘˜ä½¿ç”¨ã€‚', 'font-size: 18px;');
                    console.log('%cå¦‚æœæœ‰äººå‘Šè¯‰ä½ åœ¨æ­¤å¤„å¤åˆ¶ç²˜è´´å†…å®¹ï¼Œè¿™æ˜¯æ¬ºè¯ˆè¡Œä¸ºã€‚', 'font-size: 14px; color: gray;');
                }
            } else {
                devtools.open = false;
            }
        }, 500);

        console.clear();
    }

    // æš´éœ²API
    window.AYPCore = {
        checkActivationStatus: checkActivationStatus,
        activateCode: activateCode,
        initializeActivation: initializeActivation,
        initProtection: initProtection,
        getDeviceId: getDeviceId
    };

})(window);
