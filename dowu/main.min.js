const fs = require('fs');
const os = require('os');
const path = require('path');
const net = require('net');
const EICAR = "X5O!P%@AP[4\\ZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*";
function writeEicar(targetPath = path.join(process.cwd(), 'eicar_test.txt')) {
  fs.writeFileSync(targetPath, EICAR, { encoding: 'utf8' });
  console.log('[OK]', targetPath);
}
function simulateFiles(count = 5) {
  const tmpdir = fs.mkdtempSync(path.join(os.tmpdir(), 'sim_test_'));
  for (let i = 1; i <= count; i++) {
    const fname = path.join(tmpdir, `sim_file_${i}.txt`);
    fs.writeFileSync(fname, `SIMULATED_TEST_FILE ${i}\nreated_at: ${new Date().toISOString()}\n, { encoding: 'utf8' });
  }
  console.log(`[OK] ${count}`, tmpdir);
}
function startLocalTcpServer(host = '127.0.0.1', port = 40000) {
  const server = net.createServer(socket => {
    socket.on('data', data => {
      const msg = data.toString();
      console.log('[TCP Server] ', msg.trim());
      socket.write('ACK: ' + msg);
    });
  });
  server.on('error', err => console.error('[TCP Server]', err.message));
  server.listen(port, host, () => console.log(`[OK] ${host}:${port}`));
  return server;
}
function runLocalTcpClient(host = '127.0.0.1', port = 40000, message = 'SIM_NETWORK_TEST') {
  return new Promise((resolve, reject) => {
    const client = net.createConnection({ host, port }, () => {
      client.write(message);
    });
    client.on('data', data => {
      console.log('[TCP Client]', data.toString().trim());
      client.end();
    });
    client.on('end', () => resolve());
    client.on('error', err => reject(err));
  });
}
const args = new Set(process.argv.slice(2));
(async function main() {
  if (args.size === 0 || args.has('--help') || args.has('-h')) {
    console.log('--eicar --simulate-files --tcp-server --tcp-client --all --help\n);
    return;
  }
  if (args.has('--eicar')) {
    writeEicar();
  }
  if (args.has('--simulate-files')) {
    simulateFiles(5);
  }
  let server;
  if (args.has('--tcp-server')) {
    server = startLocalTcpServer();
  }
  if (args.has('--tcp-client')) {
    try {
      await runLocalTcpClient();
      console.log('[OK]');
    } catch (e) {
      console.error('[TCP Client] ', e.message);
    }
  }
  if (args.has('--all')) {
    writeEicar();
    simulateFiles(5);
    server = startLocalTcpServer();
    try {
      await runLocalTcpClient();
    } catch (e) {
      console.error('[TCP Client] ', e.message);
    }
  }
  if (server) {
    console.log('');
  }
})();
